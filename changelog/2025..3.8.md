# 2025.3.8 更新日志

## 修复内容

### 1. 修复 `unstakeLocked` 函数中的错误

修复了 `unstakeLocked` 函数在连续调用时可能失败的问题。在之前的实现中，当用户尝试连续解锁多个质押时，第一次解锁成功后，后续的解锁操作会失败，并显示错误信息 "Stake already withdrawn"。

#### 问题原因

问题出在 `safeHskTransfer` 方法的实现上，该方法在转账时依赖于 `totalPooledHSK` 的值，而 `totalPooledHSK` 在第一次解锁后会发生变化，导致后续解锁操作的计算出现错误。

#### 解决方案

修改了 `safeHskTransfer` 方法的实现，不再依赖 `totalPooledHSK` 的值，而是直接使用传入的 `amount` 参数进行转账。这确保了即使 `totalPooledHSK` 发生变化，后续的解锁操作也能正确执行。

### 2. 新增 `totalPaidRewards` 状态变量

为了更准确地跟踪和管理已支付的奖励，合约新增了 `totalPaidRewards` 状态变量。该变量记录了合约自部署以来已经支付给用户的总奖励金额，有助于更精确地计算和验证奖励分配。

#### 存储布局影响

**重要提示**：新增状态变量会改变合约的存储布局。在使用可升级合约模式（如透明代理或UUPS）时，必须遵循以下规则以确保安全升级：

1. **存储槽冲突**：新增的 `totalPaidRewards` 变量会占用一个新的存储槽。我们已确保该变量被添加到合约的末尾，不会与现有变量的存储槽发生冲突。

2. **升级兼容性**：此次升级采用了追加式变量添加方法，保持了与之前版本的存储布局兼容性。现有的状态变量位置保持不变，确保升级后用户的质押数据和奖励信息不会丢失或错位。

3. **验证措施**：在部署前，我们使用了存储布局比较工具验证新旧合约的存储兼容性，确保升级过程不会导致数据损坏。

### 3. 优化 `sharesAmount` 和 `hskAmount` 的计算精度

优化了 `sharesAmount` 和 `hskAmount` 之间的转换计算，确保在所有情况下（包括质押、解锁、奖励分配等）两者之间的误差不超过5%。这提高了合约的精确性和可靠性，特别是在处理大量质押和解锁操作时。

### 4. 增强合约的稳定性

增强了合约在极端情况下的稳定性，例如当 `totalShares` 接近0时，确保汇率计算不会出现异常。这防止了在大部分质押被解锁后可能出现的数值溢出或除以零的错误。

## 验证结果

通过全面的测试验证，确认了以下几点：

1. 用户现在可以连续解锁多个质押，而不会遇到之前的错误。
2. 在所有测试场景中，`sharesAmount` 和 `hskAmount` 之间的误差都远低于5%，大多数情况下接近0%。
3. 合约在处理极端情况（如大量质押和解锁、高奖励率等）时表现稳定。
4. 新增的 `totalPaidRewards` 变量正确记录了已支付的奖励，并在各种测试场景中表现一致。
5. 存储布局升级测试确认了合约升级的安全性，不会影响现有用户数据。

## 影响范围

此次更新不会影响现有用户的质押状态或奖励计算，只是修复了可能导致用户无法连续解锁多个质押的问题，并提高了合约的精确性和稳定性。用户可以继续正常使用所有功能，包括质押、解锁和查询奖励等。

## 升级注意事项

1. **升级过程**：此次升级需要使用代理合约的升级机制进行，确保使用正确的管理员账户执行升级操作。

2. **存储兼容性**：虽然我们已确保存储布局兼容，但仍建议在主网升级前在测试网进行完整的升级测试，验证所有功能和数据的正确性。

3. **监控建议**：升级后，建议密切监控合约的运行情况，特别是与新增 `totalPaidRewards` 变量相关的功能，确保奖励计算和分配正常进行。
